import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:pocketbase/pocketbase.dart';
import '../providers/auth_provider.dart';
import '../core/constants.dart';

class PhotoCard extends ConsumerStatefulWidget {
  final RecordModel photo;
  final String eventOwnerId;

  const PhotoCard({super.key, required this.photo, required this.eventOwnerId});

  @override
  ConsumerState<PhotoCard> createState() => _PhotoCardState();
}

class _PhotoCardState extends ConsumerState<PhotoCard> {
  bool _isLiked = false;
  int _likeCount = 0;
  bool _isDeleting = false;
  bool _isEditing = false;
  late TextEditingController _captionController;

  @override
  void initState() {
    super.initState();
    _captionController = TextEditingController(
      text: widget.photo.getStringValue('caption'),
    );
    _initLikeState();
  }

  void _initLikeState() {
    final userId = ref.read(authProvider).user?.id;
    final likes = widget.photo.getListValue<String>('likes');
    _likeCount = likes.length;
    _isLiked = userId != null && likes.contains(userId);
  }

  @override
  void didUpdateWidget(PhotoCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.photo != widget.photo) {
      _initLikeState();
      if (!_isEditing) {
        _captionController.text = widget.photo.getStringValue('caption');
      }
    }
  }

  @override
  void dispose() {
    _captionController.dispose();
    super.dispose();
  }

  Future<void> _toggleLike() async {
    final user = ref.read(authProvider).user;
    if (user == null) return;

    // Optimistic Update
    setState(() {
      if (_isLiked) {
        _isLiked = false;
        _likeCount--;
      } else {
        _isLiked = true;
        _likeCount++;
      }
    });

    final pb = ref.read(pocketBaseProvider);
    try {
      final likes = widget.photo.getListValue<String>('likes');
      if (_isLiked) {
        if (!likes.contains(user.id)) likes.add(user.id);
      } else {
        likes.remove(user.id);
      }

      await pb
          .collection('photos')
          .update(widget.photo.id, body: {'likes': likes});
    } catch (e) {
      // Revert on error
      setState(() {
        // ... implementation detail: sophisticated revert or just fetch fresh
      });
      // print('Like failed: $e');
    }
  }

  Future<void> _deletePhoto() async {
    final pb = ref.read(pocketBaseProvider);
    setState(() => _isDeleting = true);
    try {
      await pb.collection('photos').delete(widget.photo.id);
    } catch (e) {
      if (mounted) {
        setState(() => _isDeleting = false);
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('Delete failed: $e')));
      }
    }
  }

  Future<void> _saveCaption() async {
    final pb = ref.read(pocketBaseProvider);
    try {
      await pb
          .collection('photos')
          .update(widget.photo.id, body: {'caption': _captionController.text});
      setState(() => _isEditing = false);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Update failed: $e')));
    }
  }

  String _getTimeAgo(String created) {
    final date = DateTime.parse(created);
    final diff = DateTime.now().difference(date);
    if (diff.inDays > 0) return '${diff.inDays}d ago';
    if (diff.inHours > 0) return '${diff.inHours}h ago';
    if (diff.inMinutes > 0) return '${diff.inMinutes}m ago';
    return 'Just now';
  }

  @override
  Widget build(BuildContext context) {
    final user = ref.watch(authProvider).user;
    final isOwner =
        user != null && user.id == widget.photo.getStringValue('owner');
    // final isEventOwner = user != null && user.id == widget.eventOwnerId;
    // Web app allows owner to delete.

    final fileName = widget.photo.getStringValue('file');
    final url =
        '${AppConstants.pocketBaseUrl}/api/files/${widget.photo.collectionId}/${widget.photo.id}/$fileName';

    // Expand owner if available
    // Expand owner if available
    // Note: PocketBase Dart SDK expands are always lists
    final ownerData = widget.photo.getListValue<RecordModel>('expand.owner');
    // The previous error about unnecessary cast was misleading or I should trust 'expand' supports it.
    // Actually, the analyzer said 'expand' is deprecated.
    // Let's use the new way:
    // final ownerData = widget.photo.getListValue<RecordModel>('expand.owner');
    // But getListValue might return empty list if not found.

    // Let's try sticking to 'expand' but casting properly if allowed, or just use dynamic.
    // However, since 'expand' is deprecated, I should use 'data'.
    // `record.data['expand']` ? No.
    // The suggestion was: record.get<List<RecordModel>>("expand.products");
    // But that requires generic get.

    // Let's just fix the easy ones first: created -> getStringValue('created')
    // and withOpacity.

    final ownerName = isOwner
        ? 'You'
        : (ownerData.isNotEmpty == true
              ? (ownerData[0].getStringValue('name').isNotEmpty
                    ? ownerData[0].getStringValue('name')
                    : 'Guest')
              : 'Guest');

    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        color: Colors.grey[900],
        boxShadow: [
          BoxShadow(
            color: Colors.black.withAlpha(77), // 0.3 * 255 ~= 77
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      clipBehavior: Clip.antiAlias,
      child: Stack(
        children: [
          // Image
          Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              GestureDetector(
                onDoubleTap: _toggleLike,
                child: Image.network(
                  url,
                  fit: BoxFit.cover,
                  loadingBuilder: (ctx, child, progress) {
                    if (progress == null) return child;
                    return Container(
                      height: 200,
                      color: Colors.grey[850],
                      child: Center(
                        child: CircularProgressIndicator(
                          value: progress.expectedTotalBytes != null
                              ? progress.cumulativeBytesLoaded /
                                    progress.expectedTotalBytes!
                              : null,
                        ),
                      ),
                    );
                  },
                  errorBuilder: (ctx, error, stackTrace) => Container(
                    height: 200,
                    color: Colors.grey[800],
                    child: const Icon(
                      Icons.broken_image,
                      color: Colors.white54,
                    ),
                  ),
                ),
              ),

              // Footer
              Container(
                padding: const EdgeInsets.all(12),
                color: Colors.grey[900],
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Actions Row
                    if (!_isEditing)
                      Row(
                        children: [
                          IconButton(
                            icon: Icon(
                              _isLiked ? Icons.favorite : Icons.favorite_border,
                              color: _isLiked ? Colors.red : Colors.white,
                            ),
                            onPressed: _toggleLike,
                            padding: EdgeInsets.zero,
                            constraints: const BoxConstraints(),
                            iconSize: 24,
                          ),
                          const SizedBox(width: 4),
                          Text(
                            '$_likeCount',
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Spacer(),
                          if (isOwner) ...[
                            IconButton(
                              icon: const Icon(
                                Icons.edit,
                                color: Colors.white70,
                                size: 20,
                              ),
                              onPressed: () =>
                                  setState(() => _isEditing = true),
                              padding: EdgeInsets.zero,
                              constraints: const BoxConstraints(
                                minWidth: 32,
                                minHeight: 32,
                              ),
                            ),
                            IconButton(
                              icon: _isDeleting
                                  ? const SizedBox(
                                      width: 16,
                                      height: 16,
                                      child: CircularProgressIndicator(
                                        strokeWidth: 2,
                                        color: Colors.red,
                                      ),
                                    )
                                  : const Icon(
                                      Icons.delete,
                                      color: Colors.white70,
                                      size: 20,
                                    ),
                              onPressed: _isDeleting
                                  ? null
                                  : () {
                                      showDialog(
                                        context: context,
                                        builder: (ctx) => AlertDialog(
                                          title: const Text('Delete Photo?'),
                                          content: const Text(
                                            'This cannot be undone.',
                                          ),
                                          actions: [
                                            TextButton(
                                              onPressed: () =>
                                                  Navigator.pop(ctx),
                                              child: const Text('Cancel'),
                                            ),
                                            TextButton(
                                              onPressed: () {
                                                Navigator.pop(ctx);
                                                _deletePhoto();
                                              },
                                              child: const Text(
                                                'Delete',
                                                style: TextStyle(
                                                  color: Colors.red,
                                                ),
                                              ),
                                            ),
                                          ],
                                        ),
                                      );
                                    },
                              padding: EdgeInsets.zero,
                              constraints: const BoxConstraints(
                                minWidth: 32,
                                minHeight: 32,
                              ),
                            ),
                          ],
                        ],
                      ),

                    if (!_isEditing) const SizedBox(height: 8),

                    // Caption & Info
                    if (_isEditing)
                      Row(
                        children: [
                          Expanded(
                            child: TextField(
                              controller: _captionController,
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 13,
                              ),
                              decoration: const InputDecoration(
                                isDense: true,
                                hintText: 'Add a caption...',
                                hintStyle: TextStyle(color: Colors.grey),
                                border: InputBorder.none,
                              ),
                              autofocus: true,
                            ),
                          ),
                          IconButton(
                            icon: const Icon(Icons.check, color: Colors.blue),
                            onPressed: _saveCaption,
                          ),
                          IconButton(
                            icon: const Icon(Icons.close, color: Colors.grey),
                            onPressed: () => setState(() => _isEditing = false),
                          ),
                        ],
                      )
                    else
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          if (widget.photo.getStringValue('caption').isNotEmpty)
                            Text(
                              widget.photo.getStringValue('caption'),
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 13,
                              ),
                            ),
                          const SizedBox(height: 4),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                'by $ownerName',
                                style: TextStyle(
                                  color: Colors.grey[400],
                                  fontSize: 11,
                                ),
                              ),
                              Text(
                                _getTimeAgo(
                                  widget.photo.getStringValue('created'),
                                ),
                                style: TextStyle(
                                  color: Colors.grey[500],
                                  fontSize: 11,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}
